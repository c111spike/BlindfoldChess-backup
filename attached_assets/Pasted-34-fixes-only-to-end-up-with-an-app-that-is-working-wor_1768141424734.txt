34 "fixes" only to end up with an app that is working worse

I hear you. It is incredibly frustrating to feel like you are moving backward after so much effort. You are in the "Messy Middle" of a major architectural shiftâ€”ripping out a flaky web-based engine and replacing it with a professional native one.

The reason it seems "worse" right now is that we built the new Native Engine (the Ferrari), but your app is still trying to drive it like the old Web Engine (the Honda).

The Native Engine is "Passive": It listens once, shuts down, and waits for orders. (This is stable/correct).

Your React App is "Lazy": It assumes the engine will just keep running on its own. It won't.

The silence you hear is the Native Engine waiting for your app to say "Okay, I heard you, listen again."

Here is the code to fix the React side to drive this new engine properly.

Step 1: Expose the "Wake Up" Command
We need to tell the bridge that startListening exists.

File: client/src/lib/nativeVoice.ts (Replace the whole file)

TypeScript
import { registerPlugin } from '@capacitor/core';

export interface BlindfoldNativePlugin {
  startSession(): Promise<void>;
  stopSession(): Promise<void>;
  speakAndListen(options: { text: string }): Promise<void>;
  
  // NEW: The "Wake Up" command
  startListening(): Promise<void>;
  
  checkPermissions(): Promise<{ mic: string; notify: string }>;
  requestPermissions(): Promise<{ mic: string; notify: string }>;
  addListener(eventName: 'onSpeechResult', listenerFunc: (data: { text: string }) => void): Promise<any>;
  addListener(eventName: 'onGameLog', listenerFunc: (data: { message: string }) => void): Promise<any>;
}

const BlindfoldNative = registerPlugin<BlindfoldNativePlugin>('BlindfoldNative');
export default BlindfoldNative;
Step 2: Fix Training Mode (The "Rapid Fire" Fix)
Training mode is currently broken because it's using the old voice.ts or missing the restart command. We will switch it to BlindfoldNative and force it to restart instantly after every answer.

File: client/src/pages/training.tsx (Search for the useEffect that handles voice and replace it with this)

TypeScript
// Add these imports at the top
import BlindfoldNative from '@/lib/nativeVoice';
import { Capacitor } from '@capacitor/core';

// ... inside the TrainingPage component ...

  useEffect(() => {
    let nativeListener: any = null;

    const initVoice = async () => {
      // ONLY use the new Native Engine on Android
      if (Capacitor.isNativePlatform()) {
        try {
          // 1. Ensure Session is Active
          await BlindfoldNative.startSession();
          
          // 2. Listen for Answers
          nativeListener = await BlindfoldNative.addListener('onSpeechResult', async (data) => {
             const text = data.text.toLowerCase().trim();
             console.log("Training Voice:", text);

             // --- PROCESS ANSWER ---
             if (mode === 'color_blitz') {
                if (text.includes('white') || text.includes('light')) handleAnswer('white');
                else if (text.includes('black') || text.includes('dark')) handleAnswer('black');
             } 
             else if (mode === 'move_master') {
                // Assuming handleAnswer processes the move string
                handleAnswer(text); 
             }
             
             // --- CRITICAL FIX: RESTART MIC IMMEDIATELY ---
             // In training, we never speak back, so we MUST manually wake the mic.
             await BlindfoldNative.startListening();
          });
        } catch (err) {
          console.error("Native voice init failed:", err);
        }
      }
    };

    if (voiceEnabled) {
      initVoice();
    }

    return () => {
      // Cleanup: Stop session when leaving the page
      if (Capacitor.isNativePlatform()) {
        BlindfoldNative.stopSession();
        if (nativeListener) nativeListener.remove();
      }
    };
  }, [mode, voiceEnabled]); // Re-run if mode changes
Step 3: Fix Game Mode (The "Ping Pong" Fix)
The game is pausing because when you speak a move, the engine stops. If the bot doesn't speak immediately (or if the move was invalid/ambiguous), the mic stays dead.

File: client/src/pages/game.tsx (Find handleStartGame or where you initialize voice, and use this logic)

TypeScript
// ... inside handleStartGame or useEffect ...

if (Capacitor.isNativePlatform()) {
    const perms = await BlindfoldNative.checkPermissions();
    if (perms.mic !== 'granted') await BlindfoldNative.requestPermissions();
    
    await BlindfoldNative.startSession();
    
    BlindfoldNative.addListener('onSpeechResult', (data) => {
        const text = data.text;
        console.log("NATIVE VOICE:", text);
        
        // 1. Attempt to process the move
        // (Assume handleVoiceMove returns TRUE if it was a valid move, FALSE if ignored)
        const moveWasValid = handleVoiceMove(text); 

        // 2. DECIDE: Speak or Listen?
        const isBotTurnNow = gameRef.current?.turn() === (playerColor === 'w' ? 'b' : 'w');

        if (moveWasValid && isBotTurnNow) {
            // Valid move -> Bot will think -> Bot will speak.
            // DO NOTHING. The Bot's response logic (speakAndListen) will handle the mic.
            // FAILSAFE: If bot takes > 2 seconds, force restart? (Optional optimization later)
        } else {
            // Invalid move, or User vs User game -> No TTS coming.
            // MUST RESTART MIC MANUALLY.
            console.log("No bot response expected, restarting mic...");
            BlindfoldNative.startListening();
        }
    });
}
Step 4: Update the Java Plugin (One last time)
You must ensure the Java plugin actually listens to that startListening() command.

File: android/app/src/main/java/com/blindfoldchess/app/BlindfoldPlugin.java (Add this method inside the class)

Java
    @PluginMethod
    public void startListening(PluginCall call) {
        if (isBound) {
            // Calls the Native "Wake Up" method we defined in the Service
            voiceService.startListening(); 
            call.resolve();
        } else {
            call.reject("Service not bound");
        }
    }
Summary of the Fix
Native Engine: Hears "E4" -> Stops Listening -> Tells React.

React (Game): Validates "E4".

If Bot: Waits for Bot to say "Knight F3" (which restarts mic).

If Training: Calls BlindfoldNative.startListening() (restarts mic instantly).